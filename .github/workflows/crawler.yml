name: Auto Update Resource Pack

on:
  # æ¯ä¸¤å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */8 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-crawler-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4
      
      - name: Run crawler
        id: run-crawler
        run: |
          python crawler.py
          
          # æ£€æŸ¥æ˜¯å¦æœ‰èµ„æºåŒ…è¢«ä¸‹è½½
          if git status --porcelain | grep -E "resource_pack/|sha256/" | grep -v ".commit$" | grep -v ".md5$" | grep ".zip$"; then
            echo "resource_pack_changed=true" >> $GITHUB_OUTPUT
          else
            echo "resource_pack_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
      
      - name: Update README from template
        id: update-readme
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          export TZ='Asia/Shanghai'
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
          echo "å½“å‰æ—¶é—´: $CURRENT_TIME"
          
          # ç»Ÿè®¡èµ„æºåŒ…æ•°é‡
          if [ -d "resource_pack" ]; then
            PACK_COUNT=$(ls -1 resource_pack/*.zip 2>/dev/null | wc -l)
          else
            PACK_COUNT=0
          fi
          echo "èµ„æºåŒ…æ•°é‡: $PACK_COUNT"
          
          # æ£€æŸ¥README_TEMPLATE.mdæ˜¯å¦å­˜åœ¨
          if [ -f "README_TEMPLATE.md" ]; then
            echo "æ‰¾åˆ°README_TEMPLATE.mdï¼Œæ­£åœ¨æ›´æ–°README.md"
            
            # ä½¿ç”¨sedæ›¿æ¢æ¨¡æ¿å˜é‡å¹¶ç”ŸæˆREADME.md
            sed -e "s/{{UPDATE_TIME}}/$CURRENT_TIME/g" \
                -e "s/{{PACK_COUNT}}/$PACK_COUNT/g" \
                README_TEMPLATE.md > README.md
            
            echo "README.mdå·²æ›´æ–°"
            echo "readme_updated=true" >> $GITHUB_OUTPUT
          else
            echo "è­¦å‘Š: README_TEMPLATE.mdä¸å­˜åœ¨ï¼Œè·³è¿‡READMEæ›´æ–°"
            echo "readme_updated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹
          if git diff --quiet && [ "${{ steps.run-crawler.outputs.resource_pack_changed }}" = "false" ]; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ›´æ”¹çš„æ–‡ä»¶
            echo "Changed files:"
            git status --porcelain
          fi
      
      - name: Commit and push if changed
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add -A
          
          # è·å–æäº¤ä¿¡æ¯
          export TZ='Asia/Shanghai'
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          # æ„å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨æ›´æ–°: $CURRENT_TIME"
          
          # æ·»åŠ è¯¦ç»†è¯´æ˜
          if [ "${{ steps.run-crawler.outputs.resource_pack_changed }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - èµ„æºåŒ…æ›´æ–°"
          fi
          
          if [ "${{ steps.update-readme.outputs.readme_updated }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - READMEæ›´æ–°"
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ä»“åº“
          git push