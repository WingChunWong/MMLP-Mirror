name: Auto Update Resource Pack

on:
  # æ¯ä¸¤å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */2 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-crawler-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4
      
      - name: Run crawler
        id: run-crawler
        run: |
          python crawler.py
          
          # æ£€æŸ¥æ˜¯å¦æœ‰èµ„æºåŒ…è¢«ä¸‹è½½
          if git status --porcelain | grep -E "resource_pack/|sha256/" | grep -v ".commit$" | grep -v ".md5$" | grep ".zip$"; then
            echo "resource_pack_changed=true" >> $GITHUB_OUTPUT
          else
            echo "resource_pack_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
      
      - name: Generate README from template
        id: generate-readme
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          export TZ='Asia/Shanghai'
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
          echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥READMEæ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f README_TEMPLATE.md ]; then
            echo "README_TEMPLATE.md not found, creating default template"
            
            # åˆ›å»ºé»˜è®¤æ¨¡æ¿
            cat > README_TEMPLATE.md << 'EOF'
# Minecraft æ¨¡ç»„æ±‰åŒ–èµ„æºåŒ…ä»“åº“

## ä»“åº“ä¿¡æ¯
- **æœ€åæ›´æ–°æ—¶é—´**: {{UPDATE_TIME}}
- **è‡ªåŠ¨æ›´æ–°é¢‘ç‡**: æ¯2å°æ—¶
- **èµ„æºåŒ…æ•°é‡**: {{PACK_COUNT}} ä¸ª
- **æ”¯æŒç‰ˆæœ¬**: 1.12.2, 1.16, 1.18, 1.19, 1.20, 1.21 ç­‰

## ç›®å½•ç»“æ„
```
â”œâ”€â”€ resource_pack/     # èµ„æºåŒ…æ–‡ä»¶
â”œâ”€â”€ sha256/           # Commitå“ˆå¸Œè®°å½•
â””â”€â”€ README.md         # æœ¬æ–‡ä»¶
```

## ä½¿ç”¨è¯´æ˜
1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„èµ„æºåŒ…
2. æ”¾å…¥ Minecraft çš„ resourcepacks æ–‡ä»¶å¤¹
3. åœ¨æ¸¸æˆä¸­å¯ç”¨

## æ–‡ä»¶è¯´æ˜
- æ–‡ä»¶åæ ¼å¼: `Minecraft-Mod-Language-Package-ç‰ˆæœ¬-fabric.zip` (Fabricç‰ˆæœ¬)
- æ–‡ä»¶åæ ¼å¼: `Minecraft-Mod-Language-Package-ç‰ˆæœ¬.zip` (Forgeç‰ˆæœ¬)

## æ³¨æ„äº‹é¡¹
- æœ¬ä»“åº“è‡ªåŠ¨æ›´æ–°ï¼Œå¦‚éœ€ç‰¹å®šç‰ˆæœ¬è¯·åŠæ—¶ä¸‹è½½
- å¦‚é‡é—®é¢˜ï¼Œè¯·æäº¤ Issue

---

> æœ¬ä»“åº“ç”± GitHub Actions è‡ªåŠ¨ç»´æŠ¤
EOF
            
            echo "template_created=true" >> $GITHUB_OUTPUT
          else
            echo "template_created=false" >> $GITHUB_OUTPUT
          fi
          
          # ç»Ÿè®¡èµ„æºåŒ…æ•°é‡
          if [ -d "resource_pack" ]; then
            PACK_COUNT=$(ls -1 resource_pack/*.zip 2>/dev/null | wc -l)
          else
            PACK_COUNT=0
          fi
          
          # ç”Ÿæˆ README.md
          if [ -f "README_TEMPLATE.md" ]; then
            # ä½¿ç”¨ sed æ›¿æ¢æ¨¡æ¿å˜é‡
            sed -e "s/{{UPDATE_TIME}}/$CURRENT_TIME/g" \
                -e "s/{{PACK_COUNT}}/$PACK_COUNT/g" \
                README_TEMPLATE.md > README.md
            
            echo "README generated from template"
            echo "readme_generated=true" >> $GITHUB_OUTPUT
          else
            echo "README_TEMPLATE.md still missing, skipping generation"
            echo "readme_generated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹
          if git diff --quiet && [ "${{ steps.run-crawler.outputs.resource_pack_changed }}" = "false" ] && [ "${{ steps.generate-readme.outputs.template_created }}" = "false" ]; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ›´æ”¹çš„æ–‡ä»¶
            echo "Changed files:"
            git status --porcelain
          fi
      
      - name: Commit and push if changed
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add -A
          
          # è·å–æäº¤ä¿¡æ¯
          export TZ='Asia/Shanghai'
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          # æ„å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨æ›´æ–°: $CURRENT_TIME"
          
          # æ·»åŠ è¯¦ç»†è¯´æ˜
          if [ "${{ steps.run-crawler.outputs.resource_pack_changed }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - èµ„æºåŒ…æ›´æ–°"
          fi
          
          if [ "${{ steps.generate-readme.outputs.template_created }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - æ¨¡æ¿åˆ›å»º"
          elif [ "${{ steps.generate-readme.outputs.readme_generated }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - READMEç”Ÿæˆ"
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ä»“åº“
          git push