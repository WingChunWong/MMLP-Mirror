name: Auto Update Resource Pack

on:
  # æ¯ä¸¤å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */2 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-crawler-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´å†å²è®°å½•ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ­£ç¡®æ›´æ–° README
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Run crawler
      run: python crawler.py
    
    - name: Configure Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
    
    - name: Update README timestamp
      id: update-readme
      run: |
        # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        export TZ='Asia/Shanghai'
        
        # è·å–å½“å‰æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SS UTC+8ï¼‰
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
        echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
        
        # æ›´æ–° README.md ä¸­çš„æ—¶é—´æˆ³
        if [ -f README.md ]; then
          # å¤‡ä»½åŸæ–‡ä»¶
          cp README.md README.md.backup
          
          # ä½¿ç”¨ sed æ›¿æ¢æ—¶é—´æˆ³æ ‡è®°
          # å‡è®¾ README.md ä¸­æœ‰ç±»ä¼¼è¿™æ ·çš„æ ‡è®°ï¼šæœ€åæ›´æ–°æ—¶é—´ï¼š<!-- UPDATE_TIMESTAMP -->
          sed -i "s/æœ€åæ›´æ–°æ—¶é—´ï¼š<!-- UPDATE_TIMESTAMP -->/æœ€åæ›´æ–°æ—¶é—´ï¼š$CURRENT_TIME/g" README.md
          
          # æˆ–è€…å¦‚æœä½¿ç”¨å…¶ä»–æ ‡è®°ï¼Œæ¯”å¦‚ï¼šæœ€åæ›´æ–°ï¼šAUTO_UPDATE_TIME
          sed -i "s/æœ€åæ›´æ–°ï¼šAUTO_UPDATE_TIME/æœ€åæ›´æ–°ï¼š$CURRENT_TIME/g" README.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if ! diff README.md README.md.backup > /dev/null; then
            echo "README updated successfully"
            echo "readme_updated=true" >> $GITHUB_OUTPUT
          else
            echo "README not changed (timestamp already up to date)"
            echo "readme_updated=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "README.md not found, creating one with timestamp"
          echo "# Resource Pack Repository" > README.md
          echo "" >> README.md
          echo "æœ€åæ›´æ–°æ—¶é—´ï¼š$CURRENT_TIME" >> README.md
          echo "" >> README.md
          echo "æ­¤ä»“åº“å­˜å‚¨ Minecraft æ¨¡ç»„æ±‰åŒ–èµ„æºåŒ…ï¼Œç”± GitHub Actions æ¯ä¸¤å°æ—¶è‡ªåŠ¨æ›´æ–°ã€‚" >> README.md
          echo "readme_updated=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Check for changes
      id: check-changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹ï¼ˆåŒ…æ‹¬çˆ¬è™«ä¸‹è½½çš„æ–‡ä»¶å’Œ READMEï¼‰
        if git diff --quiet; then
          echo "No changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæ›´æ”¹çš„æ–‡ä»¶
          echo "Changed files:"
          git status --porcelain
        fi
    
    - name: Commit and push if changed
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
        git add -A
        
        # è·å–å½“å‰æ—¶é—´ç”¨äºæäº¤ä¿¡æ¯
        export TZ='Asia/Shanghai'
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        # æäº¤æ›´æ”¹
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ•°æ®: $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        
        # æ¨é€åˆ°ä»“åº“
        git push