name: Auto Update Resource Pack

on:
  # 每两小时运行一次
  schedule:
    - cron: '0 */2 * * *'
  
  # 允许手动触发
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-crawler-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # 获取完整历史记录，这样我们可以正确更新 README
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Run crawler
      run: python crawler.py
    
    - name: Configure Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
    
    - name: Update README timestamp
      id: update-readme
      run: |
        # 设置时区为东八区（北京时间）
        export TZ='Asia/Shanghai'
        
        # 获取当前时间（格式：YYYY-MM-DD HH:MM:SS UTC+8）
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
        echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
        
        # 更新 README.md 中的时间戳
        if [ -f README.md ]; then
          # 备份原文件
          cp README.md README.md.backup
          
          # 使用 sed 替换时间戳标记
          # 假设 README.md 中有类似这样的标记：最后更新时间：<!-- UPDATE_TIMESTAMP -->
          sed -i "s/最后更新时间：<!-- UPDATE_TIMESTAMP -->/最后更新时间：$CURRENT_TIME/g" README.md
          
          # 或者如果使用其他标记，比如：最后更新：AUTO_UPDATE_TIME
          sed -i "s/最后更新：AUTO_UPDATE_TIME/最后更新：$CURRENT_TIME/g" README.md
          
          # 检查是否有更改
          if ! diff README.md README.md.backup > /dev/null; then
            echo "README updated successfully"
            echo "readme_updated=true" >> $GITHUB_OUTPUT
          else
            echo "README not changed (timestamp already up to date)"
            echo "readme_updated=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "README.md not found, creating one with timestamp"
          echo "# Resource Pack Repository" > README.md
          echo "" >> README.md
          echo "最后更新时间：$CURRENT_TIME" >> README.md
          echo "" >> README.md
          echo "此仓库存储 Minecraft 模组汉化资源包，由 GitHub Actions 每两小时自动更新。" >> README.md
          echo "readme_updated=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Check for changes
      id: check-changes
      run: |
        # 检查是否有文件更改（包括爬虫下载的文件和 README）
        if git diff --quiet; then
          echo "No changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # 显示更改的文件
          echo "Changed files:"
          git status --porcelain
        fi
    
    - name: Commit and push if changed
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # 添加所有更改的文件
        git add -A
        
        # 获取当前时间用于提交信息
        export TZ='Asia/Shanghai'
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        # 提交更改
        git commit -m "自动更新资源包和MD5值 $(date +'%Y-%m-%d %H:%M:%S')" || echo "没有需要提交的更改"
        
        # 推送到仓库
        git push