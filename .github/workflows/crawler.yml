name: Auto Update Resource Pack

on:
  # æ¯å…«å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */8 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-crawler-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4
      
      - name: Run crawler
        id: run-crawler
        run: |
          python crawler.py
          
          # æ£€æŸ¥æ˜¯å¦æœ‰èµ„æºåŒ…æˆ–MD5æ–‡ä»¶è¢«ä¸‹è½½æˆ–æ›´æ–°
          if git status --porcelain | grep -E "resource_pack/.*\.(zip|md5)$"; then
            echo "resource_pack_changed=true" >> $GITHUB_OUTPUT
          else
            echo "resource_pack_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Update README from template
        id: update-readme
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          export TZ='Asia/Shanghai'
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
          echo "å½“å‰æ—¶é—´: $CURRENT_TIME"
          
          # ç»Ÿè®¡èµ„æºåŒ…æ•°é‡ï¼ˆåªç»Ÿè®¡.zipæ–‡ä»¶ï¼‰
          if [ -d "resource_pack" ]; then
            PACK_COUNT=$(ls -1 resource_pack/*.zip 2>/dev/null | wc -l)
          else
            PACK_COUNT=0
          fi
          echo "èµ„æºåŒ…æ•°é‡: $PACK_COUNT"
          
          # ç»Ÿè®¡MD5æ–‡ä»¶æ•°é‡
          if [ -d "resource_pack" ]; then
            MD5_COUNT=$(ls -1 resource_pack/*.md5 2>/dev/null | wc -l)
          else
            MD5_COUNT=0
          fi
          echo "MD5æ–‡ä»¶æ•°é‡: $MD5_COUNT"
          
          # ç”Ÿæˆèµ„æºåŒ…åˆ—è¡¨
          PACK_LIST=""
          if [ -d "resource_pack" ] && [ $PACK_COUNT -gt 0 ]; then
            # æŒ‰ä¿®æ”¹æ—¶é—´å€’åºæ’åˆ—
            for file in $(ls -t resource_pack/*.zip); do
              filename=$(basename "$file")
              # è·å–æ–‡ä»¶å¤§å°
              size=$(ls -lh "$file" | awk '{print $5}')
              # è·å–ä¿®æ”¹æ—¶é—´
              mtime=$(date -r "$file" +'%Y-%m-%d %H:%M:%S')
              
              # æŸ¥æ‰¾å¯¹åº”çš„MD5æ–‡ä»¶
              base_name="${filename%.zip}"
              md5_file="resource_pack/${base_name}.md5"
              
              if [ -f "$md5_file" ]; then
                md5_value=$(cat "$md5_file" 2>/dev/null | head -c 12)
                PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime}, MD5: \`${md5_value}...\`)"$'\n'
              else
                # æŸ¥æ‰¾å¸¦æœ‰ç‰ˆæœ¬å·çš„MD5æ–‡ä»¶
                # ä»æ–‡ä»¶åä¸­æå–ç‰ˆæœ¬å·
                if [[ "$filename" =~ Minecraft-Mod-Language-Modpack-(.*)\.zip ]]; then
                  version_part="${BASH_REMATCH[1]}"
                  # å¦‚æœæ˜¯ç‰¹æ®Šç‰ˆæœ¬ï¼ˆ1.12.2ï¼‰
                  if [ "$filename" = "Minecraft-Mod-Language-Modpack.zip" ]; then
                    version_part="1.12.2"
                    # å°è¯•æŸ¥æ‰¾1.12.2çš„MD5æ–‡ä»¶
                    for md5_file in resource_pack/1.12.2*.md5; do
                      if [ -f "$md5_file" ]; then
                        md5_value=$(cat "$md5_file" 2>/dev/null | head -c 12)
                        PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime}, MD5: \`${md5_value}...\`)"$'\n'
                        break
                      fi
                    done
                    # å¦‚æœæ²¡æ‰¾åˆ°MD5æ–‡ä»¶
                    if [ -z "$md5_value" ]; then
                      PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime})"$'\n'
                    fi
                  # å¦‚æœæ˜¯æ™®é€šç‰ˆæœ¬
                  elif [[ "$filename" =~ -Fabric\.zip$ ]]; then
                    # å»é™¤æœ«å°¾çš„-Fabric
                    version="${version_part%-Fabric}"
                    # å°†çŸ­æ¨ªçº¿è½¬æ¢å›ç‚¹
                    version=$(echo "$version" | tr '-' '.')
                    # æŸ¥æ‰¾å¯¹åº”çš„MD5æ–‡ä»¶
                    for md5_file in resource_pack/${version}-fabric.md5; do
                      if [ -f "$md5_file" ]; then
                        md5_value=$(cat "$md5_file" 2>/dev/null | head -c 12)
                        PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime}, MD5: \`${md5_value}...\`)"$'\n'
                        break
                      fi
                    done
                    # å¦‚æœæ²¡æ‰¾åˆ°MD5æ–‡ä»¶
                    if [ -z "$md5_value" ]; then
                      PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime})"$'\n'
                    fi
                  # éFabricç‰ˆæœ¬
                  else
                    # å°†çŸ­æ¨ªçº¿è½¬æ¢å›ç‚¹
                    version=$(echo "$version_part" | tr '-' '.')
                    # æŸ¥æ‰¾å¯¹åº”çš„MD5æ–‡ä»¶
                    for md5_file in resource_pack/${version}.md5; do
                      if [ -f "$md5_file" ]; then
                        md5_value=$(cat "$md5_file" 2>/dev/null | head -c 12)
                        PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime}, MD5: \`${md5_value}...\`)"$'\n'
                        break
                      fi
                    done
                    # å¦‚æœæ²¡æ‰¾åˆ°MD5æ–‡ä»¶
                    if [ -z "$md5_value" ]; then
                      PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime})"$'\n'
                    fi
                  fi
                else
                  PACK_LIST="${PACK_LIST}- **${filename}** (${size}, æ›´æ–°äº ${mtime})"$'\n'
                fi
              fi
            done
          else
            PACK_LIST="æš‚æ— èµ„æºåŒ…"
          fi
          
          # æ£€æŸ¥README_TEMPLATE.mdæ˜¯å¦å­˜åœ¨
          if [ -f "README_TEMPLATE.md" ]; then
            echo "æ‰¾åˆ°README_TEMPLATE.mdï¼Œæ­£åœ¨æ›´æ–°README.md"
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¹¶æ›¿æ¢æ¨¡æ¿å˜é‡
            cat README_TEMPLATE.md | \
              sed "s/{{UPDATE_TIME}}/$CURRENT_TIME/g" | \
              sed "s/{{PACK_COUNT}}/$PACK_COUNT/g" | \
              sed "s/{{MD5_COUNT}}/$MD5_COUNT/g" > temp_readme.md
            
            # å°†èµ„æºåŒ…åˆ—è¡¨æ·»åŠ åˆ°README.md
            awk -v pack_list="$PACK_LIST" '
              /{{PACK_LIST}}/ {
                print pack_list
                next
              }
              { print }
            ' temp_readme.md > README.md
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f temp_readme.md
            
            echo "README.mdå·²æ›´æ–°"
            echo "readme_updated=true" >> $GITHUB_OUTPUT
          else
            echo "è­¦å‘Š: README_TEMPLATE.mdä¸å­˜åœ¨ï¼Œè·³è¿‡READMEæ›´æ–°"
            echo "readme_updated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹
          if git diff --quiet && [ "${{ steps.run-crawler.outputs.resource_pack_changed }}" = "false" ] && [ "${{ steps.update-readme.outputs.readme_updated }}" = "false" ]; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ›´æ”¹çš„æ–‡ä»¶
            echo "Changed files:"
            git status --porcelain
            
            # æ˜¾ç¤ºè¯¦ç»†çš„æ›´æ”¹å†…å®¹
            echo -e "\nDetailed changes:"
            git diff --stat
          fi
      
      - name: Commit and push if changed
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add -A
          
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          export TZ='Asia/Shanghai'
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
          
          # è·å–æ›´æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git status --porcelain | awk '{print $2}' | head -10 | tr '\n' ',' | sed 's/,$//')
          
          # æ„å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨æ›´æ–°: $CURRENT_TIME"
          
          # æ·»åŠ è¯¦ç»†è¯´æ˜
          if [ "${{ steps.run-crawler.outputs.resource_pack_changed }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - èµ„æºåŒ…/MD5æ›´æ–°"
            if [ -n "$CHANGED_FILES" ]; then
              COMMIT_MSG="$COMMIT_MSG ($CHANGED_FILES)"
            fi
          fi
          
          if [ "${{ steps.update-readme.outputs.readme_updated }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG - READMEæ›´æ–°"
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ä»“åº“
          git push
